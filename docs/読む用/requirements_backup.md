# docs/requirements.md

## Document Metadata
- **Version**: 1.0.0
- **Last Updated**: 2026-02-04
- **Status**: Confirmed (確定版)
- **Owner**: Senior Fullstack Engineer (DDD Specialist)

---

## 1. プロジェクト概要

### 1.1 プロジェクト名
**Hyper-Custom Portfolio & Blog System**

### 1.2 目的
個人用の多機能HP兼ブログシステムを構築し、以下を実現する：
- 管理者による高度なコンテンツ管理機能
- 一般ユーザーへの最適化された閲覧体験
- データ損失リスクゼロのバックアップ体制
- ドキュメント駆動開発による長期保守性

### 1.3 開発方針
- **Document Driven Development (DDD)**: 全ての実装は設計ドキュメントに基づく
- **Single Source of Truth (SSOT)**: ドキュメントを常に最新の正解とする
- **型安全性重視**: TypeScript strict modeで厳格な型チェック
- **大規模開発許容**: 10万〜30万行規模のコードベースを想定

---

## 2. システム要件

### 2.1 機能要件

#### 2.1.1 ユーザー種別
| ユーザー種別 | 権限 | 認証方式 |
|------------|------|---------|
| **管理者** | 全機能アクセス可能 | Google OAuth (Supabase Auth) |
| **一般ユーザー** | 公開コンテンツの閲覧のみ | 認証不要 |

#### 2.1.2 コンテンツタイプ

**A. 動的コンテンツ（データベース管理）**

1. **読み物（posts）**
   - ブログ記事
   - 技術記事
   - タグによる分類（複数タグ対応）
   - ステータス管理（draft / published / scheduled）
   - 時限投稿機能

2. **作ったもの（projects）**
   - 完成したプロジェクト・実績
   - カードギャラリー型表示
   - 関連する「読み物」記事とのリレーション
   - デモURL・GitHubリポジトリ・使用技術タグ

3. **進行中のこと（in_progress）**
   - 現在進行中のプロジェクト
   - ステータス管理（未着手 / 中断中 / 進行中 / 完了）
   - 完了後は「作ったもの」へのリンク表示
   - ロードマップ・活動ログ機能

**B. 固定ページ（静的コンテンツ）**

| ページ名 | 役割 | 更新頻度 |
|---------|------|---------|
| **ホーム** | サイト全体概要・最新情報 | 高 |
| **自己紹介** | プロフィール・スキルセット | 低 |
| **作ったもの** | プロジェクト一覧（カードギャラリー） | 中 |
| **読み物** | ブログ・技術記事一覧（タグフィルタ） | 高 |
| **進行中のこと** | 現在の活動状況 | 中 |
| **関連リンク** | Qiita・SNS・外部活動先 | 低 |

#### 2.1.3 コンテンツ管理機能

**A. 記事作成・編集（Tiptap エディタ）**

| 機能カテゴリ | 機能詳細 |
|------------|---------|
| **基本編集** | 見出し、太字、斜体、下線、取り消し線、リンク |
| **リスト** | 箇条書き、番号付きリスト、チェックリスト |
| **コードブロック** | シンタックスハイライト（Shiki）、言語指定 |
| **画像** | WebP自動変換、横並びレイアウト（PC/スマホ対応） |
| **テーブル** | 挿入・編集・削除 |
| **埋め込み** | YouTube動画 |
| **数式** | KaTeX数式表示 |
| **装飾** | 蛍光ペン、文字色、背景色、テキスト配置 |
| **区切り** | 水平線、カスタムセクション区切り |
| **上付き/下付き** | 化学式・数式用 |
| **文字数カウント** | リアルタイム表示 |

**B. メタデータ管理**

| 項目 | 仕様 |
|-----|------|
| **タイトル** | 必須、最大200文字 |
| **スラッグ** | タイトルから自動生成（日本語→ローマ字 or UUID） |
| **説明文** | OGP用、最大300文字 |
| **カバー画像** | WebP形式、最大5MB |
| **タグ** | 複数選択可能、新規作成可能 |
| **公開日時** | 時限投稿用（scheduled時に使用） |
| **OGP画像** | 動的生成 or 手動アップロード |

**C. ステータス管理**

| ステータス | 説明 | 表示条件 |
|----------|------|---------|
| **draft** | 下書き | 管理者のみ閲覧可能 |
| **scheduled** | 時限投稿 | `published_at <= NOW()` で公開 |
| **published** | 公開済み | 一般ユーザー閲覧可能 |

**D. 関連リンク機能**

| 機能 | 仕様 |
|-----|------|
| **手動紐付け** | 管理画面で記事間・記事←→プロジェクト間のリンク設定 |
| **自動推薦** | タグ一致度ベースで関連記事を自動提案 |
| **表示位置** | 記事詳細ページ下部に「関連する記事」セクション |

#### 2.1.4 画像処理

| 処理段階 | 仕様 |
|---------|------|
| **アップロード前** | クライアント側でWebP変換（browser-image-compression） |
| **変換設定** | 最大幅1920px、品質80%、WebP形式 |
| **ストレージ** | Supabase Storage: `/posts/images/{post_id}/{timestamp}_{filename}.webp` |
| **表示最適化** | Next.js Image コンポーネント（Lazy Loading、レスポンシブ） |
| **横並びレイアウト** | Tiptapカスタムノード（PC/スマホ両対応） |

#### 2.1.5 時限投稿

| 項目 | 仕様 |
|-----|------|
| **判定基準** | サーバーサイド時刻のみ（クライアント時刻は無視） |
| **判定タイミング** | SSG: ビルド時 / ISR: 再生成時 / 動的: リクエスト時 |
| **ISR間隔** | 1時間（3600秒） |
| **表示ロジック** | `published_at <= NOW()` の記事のみ表示 |

#### 2.1.6 タグフィルタリング

| 機能 | 仕様 |
|-----|------|
| **URL形式** | `/posts?tags=tech,diary` |
| **複数タグ対応** | AND検索（全てのタグを含む記事のみ表示） |
| **OGP対応** | フィルタ結果ページも個別OGP生成 |
| **UI** | PC: サイドバー / スマホ: ドロワーメニュー |

#### 2.1.7 Qiita連携

| 項目 | 仕様 |
|-----|------|
| **API** | Qiita API v2（Read-only） |
| **取得情報** | タイトル、URL、いいね数、公開日 |
| **キャッシュ** | Supabase `qiita_cache` テーブルに保存 |
| **更新方法** | 管理画面「関連リンク」ページから手動更新 |
| **表示場所** | 固定ページ「関連リンク」に埋め込み |

#### 2.1.8 バックアップ・エクスポート

**A. 保存時エクスポート**
- 記事保存完了後、専用ページへ遷移
- JSON形式 + Markdown形式をダウンロード可能
- ファイル名: `{slug}_{timestamp}.json` / `.md`

**B. 全データエクスポート**
- 管理画面 `/admin/backup` からアクセス
- 全記事・プロジェクト・進行中・タグ・関連リンクを一括エクスポート
- フォーマット: JSON（DB再投入可能な構造）

**C. インポート機能**
- エクスポートしたJSONファイルからDB復元
- 画像パスの整合性チェック
- 重複記事の検出・スキップ

#### 2.1.9 検索機能

| 機能 | 実装方式 |
|-----|---------|
| **タグフィルタ** | メイン検索方法（複数タグ対応） |
| **全文検索** | Postgres Full-Text Search（`pg_trgm` + `to_tsvector`） |
| **検索対象** | 記事タイトル・本文・タグ |
| **検索結果** | タイトル一致優先 → 本文一致 |

#### 2.1.10 コメント機能（将来実装）

| 項目 | 仕様 |
|-----|------|
| **BOT対策** | reCAPTCHA v3 |
| **Rate Limiting** | 5 req/min（IP/セッションベース） |
| **承認フロー** | 管理者承認制 or 自動公開（設定可能） |
| **通知** | 新規コメント時に管理者へメール通知 |

---

### 2.2 非機能要件

#### 2.2.1 パフォーマンス

| 項目 | 目標値 |
|-----|-------|
| **初回表示時間（FCP）** | 1.5秒以内 |
| **Time to Interactive（TTI）** | 3秒以内 |
| **Lighthouse Score** | 90点以上（Performance） |
| **画像読み込み** | Lazy Loading、WebP最適化 |
| **ISR再生成** | 1時間間隔 |

#### 2.2.2 セキュリティ

| 項目 | 対策 |
|-----|------|
| **認証** | Supabase Auth（Google OAuth） |
| **認可** | Row Level Security（RLS）ポリシー |
| **XSS対策** | DOMPurify + Tiptapサニタイズ |
| **SQLインジェクション** | Supabase Prepared Statement |
| **CSRF対策** | Next.js標準保護 |
| **画像アップロード** | サイズ制限5MB、形式検証 |
| **Rate Limiting** | API: 100 req/min、画像: 10 files/min |

#### 2.2.3 可用性

| 項目 | 目標値 |
|-----|-------|
| **稼働率** | 99.9%（Vercel + Supabase SLA） |
| **バックアップ** | 毎日自動バックアップ（Supabase） |
| **復旧時間** | 24時間以内（インポート機能使用） |

#### 2.2.4 保守性

| 項目 | 対策 |
|-----|------|
| **ドキュメント駆動** | 全機能に設計書必須 |
| **型安全性** | TypeScript strict mode |
| **テストカバレッジ** | 70%以上（重要ロジックは100%） |
| **Linter/Formatter** | ESLint + Prettier |
| **コードレビュー** | Pull Request必須 |

#### 2.2.5 スケーラビリティ

| 項目 | 想定規模 |
|-----|---------|
| **記事数** | 10,000件以上 |
| **プロジェクト数** | 500件以上 |
| **画像ストレージ** | 100GB以上 |
| **同時アクセス** | 1,000人/日 |
| **データベース** | Supabase Free Tier → Pro Tierへの移行可能 |

#### 2.2.6 アクセシビリティ

| 項目 | 対応内容 |
|-----|---------|
| **WCAG準拠** | レベルAA準拠 |
| **キーボード操作** | 全機能キーボードのみで操作可能 |
| **スクリーンリーダー** | セマンティックHTML使用 |
| **カラーコントラスト** | 4.5:1以上 |
| **フォントサイズ** | レスポンシブ対応 |

---

## 3. UI/UX要件

### 3.1 デザイン方針

| 項目 | 方針 |
|-----|------|
| **全体トーン** | シンプル・モダン・読みやすさ重視 |
| **カラースキーム** | ライト/ダークモード対応 |
| **フォント** | システムフォント優先（高速表示） |
| **レイアウト** | レスポンシブデザイン（Mobile First） |
| **アニメーション** | 控えめ（パフォーマンス優先） |

### 3.2 ページ別UI仕様

#### 3.2.1 ホームページ
- ヒーローセクション（自己紹介・キャッチコピー）
- 最新記事3件（カード型）
- 最新プロジェクト3件（カード型）
- 進行中のこと（ステータス表示）
- SNSリンク

#### 3.2.2 読み物一覧ページ
- タグフィルタ（サイドバー or ドロワー）
- 記事カード（タイトル・説明・タグ・公開日・カバー画像）
- ページネーション（10件/ページ）
- 検索ボックス（タイトル・本文検索）

#### 3.2.3 記事詳細ページ
- タイトル・メタ情報（公開日・更新日・タグ）
- 目次（自動生成）
- 本文（Tiptap レンダリング）
- 関連記事（3〜5件）
- シェアボタン（Twitter・Facebook・はてブ）
- コメント欄（将来実装）

#### 3.2.4 作ったものページ
- カードギャラリー型レイアウト
- フィルタ（使用技術タグ）
- 各カード：サムネイル・タイトル・概要・技術タグ・デモURL・GitHub
- モーダルで詳細表示

#### 3.2.5 進行中のことページ
- ステータス別タブ（未着手・中断中・進行中・完了）
- タイムライン形式
- 各項目：タイトル・説明・進捗率・更新日
- 完了項目は「作ったもの」へのリンク

#### 3.2.6 管理画面
- ダッシュボード（統計情報・最近の編集）
- サイドバーナビゲーション
- 記事一覧（ステータス・検索・フィルタ）
- エディタ画面（Tiptap）
- プレビュー機能（モーダル or 別タブ）
- バックアップ管理画面

### 3.3 レスポンシブ対応

| デバイス | ブレークポイント | 主な変更点 |
|---------|---------------|-----------|
| **スマホ** | 〜640px | 1カラム、ハンバーガーメニュー |
| **タブレット** | 641px〜1024px | 2カラム、サイドバー折りたたみ |
| **PC** | 1025px〜 | 3カラム、サイドバー常時表示 |

### 3.4 ダークモード

| 項目 | 仕様 |
|-----|------|
| **切り替え** | ヘッダーにトグルボタン |
| **保存** | LocalStorageに設定保存 |
| **デフォルト** | システム設定に従う |
| **カラー** | Tailwind CSS標準カラーパレット使用 |

---

## 4. データ要件

### 4.1 データベーステーブル（概要）

| テーブル名 | 役割 | 主要カラム |
|-----------|------|-----------|
| **posts** | 記事データ | id, title, slug, content, status, published_at |
| **projects** | プロジェクト | id, title, slug, description, demo_url, github_url |
| **in_progress** | 進行中 | id, title, status, progress_rate, completed_project_id |
| **tags** | タグ | id, name, slug |
| **post_tags** | 記事タグ中間 | post_id, tag_id |
| **project_tags** | プロジェクトタグ中間 | project_id, tag_id |
| **post_links** | 記事関連リンク中間 | from_post_id, to_post_id |
| **post_project_links** | 記事プロジェクトリンク中間 | post_id, project_id |
| **pages** | 固定ページ | id, page_type, content |
| **qiita_cache** | Qiita記事キャッシュ | id, title, url, likes_count, published_at |

### 4.2 データ移行・バックアップ

| 項目 | 仕様 |
|-----|------|
| **本番→開発** | 週1回、手動エクスポート/インポート |
| **バックアップ頻度** | 毎日自動（Supabase標準機能） |
| **保持期間** | 30日間 |
| **エクスポート形式** | JSON（構造化データ） + Markdown（可読性） |

---

## 5. 外部連携要件

### 5.1 Qiita API v2

| 項目 | 仕様 |
|-----|------|
| **エンドポイント** | `https://qiita.com/api/v2/users/{username}/items` |
| **認証** | アクセストークン（環境変数） |
| **取得間隔** | 手動更新（管理画面ボタン） |
| **キャッシュ** | Supabase `qiita_cache` テーブル |
| **表示件数** | 最新10件 |

### 5.2 Google Analytics 4

| 項目 | 仕様 |
|-----|------|
| **配置** | 全ページ（控えめ） |
| **トラッキング** | ページビュー・イベント |
| **Cookie同意** | 不要（GA4標準設定） |

### 5.3 Vercel Analytics

| 項目 | 仕様 |
|-----|------|
| **配置** | 全ページ |
| **計測項目** | Core Web Vitals、エラー率 |

### 5.4 reCAPTCHA v3（将来実装）

| 項目 | 仕様 |
|-----|------|
| **配置** | コメントフォーム |
| **スコア閾値** | 0.5以上で承認 |

---

## 6. 開発環境要件

### 6.1 推奨開発環境

| 項目 | 推奨 |
|-----|------|
| **OS** | Windows / macOS / Linux |
| **エディタ** | VSCode |
| **Node.js** | 20.x LTS |
| **npm** | 10.x |
| **ブラウザ** | Chrome最新版（開発者ツール使用） |

### 6.2 必須ツール

- Git（バージョン管理）
- Supabase CLI（DB管理）
- Vercel CLI（デプロイ）

---

## 7. 制約事項

### 7.1 技術的制約

| 項目 | 制約内容 |
|-----|---------|
| **Supabase Free Tier制限** | DB: 500MB、Storage: 1GB、Auth: 50,000 MAU |
| **Vercel Free Tier制限** | 100GB帯域/月、100 実行時間時間/月 |
| **画像サイズ** | 最大5MB/枚 |
| **記事文字数** | 実質無制限（DB TEXT型） |

### 7.2 運用制約

| 項目 | 制約内容 |
|-----|---------|
| **管理者** | 単一アカウントのみ |
| **バックアップ** | 手動エクスポート必須（週1回推奨） |
| **Qiita更新** | 手動トリガーのみ |

---

## 8. 成功基準

### 8.1 機能面
- ✅ 全ての記事作成機能が正常動作
- ✅ 時限投稿が正確に動作（サーバー時刻基準）
- ✅ バックアップ・復元が100%成功
- ✅ 画像WebP変換・アップロードが正常動作

### 8.2 パフォーマンス面
- ✅ Lighthouse Performance Score 90点以上
- ✅ FCP 1.5秒以内
- ✅ 画像Lazy Loading正常動作

### 8.3 品質面
- ✅ TypeScript型エラー 0件
- ✅ テストカバレッジ 70%以上
- ✅ ESLintエラー 0件

---

## 9. リリース計画

### 9.1 フェーズ分け

| Phase | 内容 | 期間目安 |
|-------|------|---------|
| **Phase 1** | Architecture & Schema設計 | 1週間 |
| **Phase 2** | UI/UX設計 | 1週間 |
| **Phase 3** | コア機能実装（記事CRUD） | 2週間 |
| **Phase 4** | 高度機能実装（Tiptap拡張） | 2週間 |
| **Phase 5** | バックアップ・Qiita連携 | 1週間 |
| **Phase 6** | テスト・最適化 | 1週間 |
| **Phase 7** | デプロイ・公開 | 1週間 |

### 9.2 マイルストーン

- **M1**: 設計ドキュメント完成（Phase 1-2）
- **M2**: 基本機能実装完了（Phase 3）
- **M3**: 高度機能実装完了（Phase 4-5）
- **M4**: 本番リリース（Phase 6-7）

---

## 10. 今後の拡張機能（優先度順）

### 10.1 優先度: 高
1. コメント機能（BOT対策付き）
2. RSS/Atom Feed
3. サイトマップ自動生成
4. 記事シリーズ機能（連載記事）

### 10.2 優先度: 中
1. 全文検索強化（Algolia導入検討）
2. 多言語対応（i18n）
3. 記事バージョン管理（差分表示）
4. 記事テンプレート機能

### 10.3 優先度: 低
1. SNS自動投稿連携
2. Markdown直接インポート
3. 記事統計ダッシュボード
4. A/Bテスト機能

---

## 11. 承認状態

✅ **確定済み** - 本要件定義書に基づいて開発を進めます。

次のステップ:
1. `docs/architecture.md` v2.0 更新
2. `docs/data-schema.md` 作成
3. `docs/ui-spec.md` 作成
4. `docs/logic-flow.md` 作成
5. `docs/implementation-plan.md` 作成
